pipeline {
    agent any
    environment {
        AWS_ACCESS_KEY_ID = credentials ('AWS-Access-key')
        AWS_SCERET_ACCESS_KEY = credentials ('Secret access key')
        region = "us-east-1"
        
    }
        stages {
            stage('Checkout SCM'){
                steps{
                    script{
                        checkout scmGit(branches: [[name: '*/main']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/mallika86/Terraform-Jenkins-EKS.git']])
                    }
                }
                
            }
            stage('Initializing Terraform'){
                steps{
                    script{
                        dir('EKS'){
                            sh 'terraform init'
                        }
                    }
                }
            }
            stage('formatting Terraform Code'){
                steps{
                    script{
                        dir('EKS'){
                            sh 'terraform fmt'
                        }
                    }
                }
            }
            stage('Validating Terraform Code'){
                steps{
                    script{
                        dir('EKS'){
                            sh 'terraform validate'
                        }
                    }
                }
            }
            stage('Provising the infra using Terraform Code'){
                steps{
                    script{
                        dir('EKS'){
                            sh 'terraform plan'
                        }
                    }
                }
            }
            stage('Creating an EKS Cluster'){
                steps{
                    script{
                        dir('EKS'){
                            sh 'terraform apply --auto-approve'
                        }
                    }
                }
            }   
        }   
}

